<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Sheet Music Player</title>
  <meta name="description" content="Play and learn MusicXML sheet music with MIDI feedback, highlights, and adjustable BPM.">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/opensheetmusicdisplay/1.7.0/opensheetmusicdisplay.min.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #1e3a8a, #3b82f6);
      margin: 0;
      padding: 0;
      color: #1f2937;
    }
    .container {
      max-width: 960px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .file-upload, .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      align-items: center;
    }
    .file-upload input[type="file"], .file-upload select, .controls button, .controls input[type=range] {
      padding: 0.5rem 1rem;
      border: 1px solid #cbd5e0;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 1rem;
    }
    .controls button {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #sheet-container {
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 1rem;
      background: #f7fafc;
      overflow-x: auto;
      height: 500px;
    }
    .highlight-measure {
      stroke: orange !important;
      stroke-width: 4 !important;
      stroke-opacity: 0.3 !important;
      fill-opacity: 0.1 !important;
    }
    .highlight-note {
      fill: orange !important;
      stroke: orange !important;
      stroke-width: 1 !important;
      fill-opacity: 0.3 !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align:center; font-size: 2rem; font-weight: 800; color: #1e3a8a; margin-bottom: 1.5rem;">ğŸ¼ AI Sheet Music Player</h1>

    <div class="file-upload">
      <input type="file" id="file-input" accept=".musicxml,.xml,.mxl">
      <select id="instrument-select">
        <option value="acoustic_grand_piano">ğŸ¹ Piano</option>
        <option value="violin">ğŸ» Violin</option>
        <option value="flute">ğŸ¶ Flute</option>
        <option value="acoustic_guitar_nylon">ğŸ¸ Guitar</option>
        <option value="soprano_sax">ğŸ· Saxophone</option>
        <option value="trombone">ğŸº Trombone</option>
        <option value="cello">ğŸ» Cello</option>
      </select>
      <label for="speed-range">BPM: <span id="speed-display">120</span></label>
      <input type="range" id="speed-range" min="30" max="240" value="120">
      <label><input type="checkbox" id="training-toggle"> Training Mode</label>
    </div>

    <div class="controls">
      <button id="play-btn" style="background-color: #22c55e; color: white;">â–¶ï¸ Play</button>
      <button id="stop-btn" style="background-color: #ef4444; color: white;">â¹ Stop</button>
    </div>

    <div id="sheet-container"></div>
  </div>
  <script src="opensheetmusicdisplay.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.15.1/dist/soundfont-player.min.js"></script>
  <script>
    let osmd;
    let audioContext;
    let instrumentPlayer;
    let noteSequence = [];
    let currentNoteIndex = 0;
    let playing = false;
    let bpm = 120;
    let trainingMode = false;

    const fileInput = document.getElementById("file-input");
    const sheetContainer = document.getElementById("sheet-container");
    const playBtn = document.getElementById("play-btn");
    const stopBtn = document.getElementById("stop-btn");
    const instrumentSelect = document.getElementById("instrument-select");
    const speedRange = document.getElementById("speed-range");
    const speedDisplay = document.getElementById("speed-display");
    const trainingToggle = document.getElementById("training-toggle");

    speedRange.addEventListener('input', () => {
      bpm = parseInt(speedRange.value);
      speedDisplay.textContent = bpm;
    });

    trainingToggle.addEventListener('change', () => {
      trainingMode = trainingToggle.checked;
    });

    async function loadInstrument(name) {
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      instrumentPlayer = await Soundfont.instrument(audioContext, name);
    }

    async function loadSheet(file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        let content = e.target.result;
        if(osmd) sheetContainer.innerHTML = ""; // clear
        osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(sheetContainer, {autoResize: true});
        await osmd.load(content);
        osmd.render();
        extractNoteSequence();
      };
      if(file.name.endsWith(".mxl")) reader.readAsArrayBuffer(file);
      else reader.readAsText(file);
    }

    fileInput.addEventListener("change", async (e) => {
      if(e.target.files.length > 0) await loadSheet(e.target.files[0]);
    });

    function extractNoteSequence() {
      noteSequence = [];
      osmd.GraphicSheet.MeasureList.forEach((measure, measureIndex) => {
        measure.Voices.forEach(voice => {
          voice.Notes.forEach(note => {
            if(!note.isRest()) {
              noteSequence.push({
                pitch: note.halfTone,
                startTime: 0, // weâ€™ll calculate relative BPM timing later
                duration: 60 / bpm, 
                measureIndex,
                noteObj: note
              });
            }
          });
        });
      });
    }

    function highlightNoteAndMeasure(index) {
      osmd.GraphicSheet.MeasureList.forEach((m, mi) => {
        const svg = m.MeasureSVG;
        if(svg) {
          if(mi === noteSequence[index].measureIndex) svg.classList.add("highlight-measure");
          else svg.classList.remove("highlight-measure");
        }
      });
      const note = noteSequence[index].noteObj;
      if(note && note.MIDINoteNumber) {
        // OSMD SVG notes highlighting
        if(note.parent) note.parent.svgElement.classList.add("highlight-note");
      }
    }

    async function playSequence(startIndex=0) {
      if(!instrumentPlayer) await loadInstrument(instrumentSelect.value);
      playing = true;
      currentNoteIndex = startIndex;

      function nextNote() {
        if(!playing || currentNoteIndex >= noteSequence.length) return;
        const note = noteSequence[currentNoteIndex];
        highlightNoteAndMeasure(currentNoteIndex);
        const noteName = midiToNoteName(note.pitch + 12); // adjust octave
        if(!trainingMode) instrumentPlayer.play(noteName, audioContext.currentTime, {duration: note.duration});
        currentNoteIndex++;
        if(!trainingMode) setTimeout(nextNote, note.duration * 1000 * (120/bpm));
      }

      nextNote();
    }

    function stopSequence() {
      playing = false;
      currentNoteIndex = 0;
      osmd.GraphicSheet.MeasureList.forEach(m => {
        if(m.MeasureSVG) m.MeasureSVG.classList.remove("highlight-measure");
      });
    }

    function midiToNoteName(midi) {
      const octave = Math.floor(midi/12)-1;
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      return `${names[midi%12]}${octave}`;
    }

    playBtn.addEventListener("click", () => playSequence(currentNoteIndex));
    stopBtn.addEventListener("click", stopSequence);

    // MIDI support
    if(navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess().then((midiAccess) => {
        midiAccess.inputs.forEach(input => {
          input.onmidimessage = (msg) => {
            const [command, noteNumber, velocity] = msg.data;
            if(command === 144 && velocity>0 && trainingMode) { // note on
              const expected = noteSequence[currentNoteIndex];
              if(expected && noteNumber === expected.pitch+60) { // adjust octave
                instrumentPlayer.play(midiToNoteName(expected.pitch+12), audioContext.currentTime, {duration: expected.duration});
                currentNoteIndex++;
                if(currentNoteIndex<noteSequence.length) highlightNoteAndMeasure(currentNoteIndex);
              }
            }
          };
        });
      });
    }
  </script>
</body>
</html>
