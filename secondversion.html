<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Sheet Music Player with MIDI Training</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right, #1e3a8a, #3b82f6); margin:0; padding:0; color:#1f2937;}
  .container { max-width:960px; margin:2rem auto; padding:2rem; background:white; border-radius:1rem; box-shadow:0 10px 25px rgba(0,0,0,0.15);}
  .file-upload, .controls { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1.5rem; align-items:center;}
  .file-upload input[type="file"], .file-upload select, .controls button, .controls input[type=range] { padding:0.5rem 1rem; border-radius:0.5rem; font-weight:600; font-size:1rem;}
  #sheet-container { border:1px solid #e2e8f0; border-radius:1rem; padding:1rem; background:#f7fafc; overflow:auto; height:500px;}
  .highlight-measure { stroke:orange !important; stroke-width:4 !important; stroke-opacity:0.5 !important; fill-opacity:0.2 !important; }
  .highlight-note { fill:orange !important; }
</style>
</head>
<body>
<div class="container">
  <h1 style="text-align:center; font-size:2rem; font-weight:800; color:#1e3a8a; margin-bottom:1.5rem;">ğŸ¼ AI Sheet Music Player</h1>
  
  <div class="file-upload">
    <input type="file" id="file-input" accept=".musicxml,.xml,.mxl">
    <select id="instrument-select">
      <option value="acoustic_grand_piano">ğŸ¹ Piano</option>
      <option value="violin">ğŸ» Violin</option>
      <option value="flute">ğŸ¶ Flute</option>
      <option value="acoustic_guitar_nylon">ğŸ¸ Guitar</option>
      <option value="soprano_sax">ğŸ· Saxophone</option>
      <option value="trombone">ğŸ¦´ Trombone</option>
      <option value="cello">ğŸ» Cello</option>
    </select>
    <label for="speed-range">Speed: <span id="speed-display">120 BPM</span></label>
    <input type="range" id="speed-range" min="30" max="240" value="120" step="1">
    <label for="mode-toggle">Listening Mode</label>
    <input type="checkbox" id="mode-toggle" checked>
  </div>

  <div class="controls">
    <button id="play-btn" style="background-color:#22c55e; color:white;">â–¶ï¸ Play</button>
    <button id="stop-btn" style="background-color:#ef4444; color:white;">â¹ Stop</button>
  </div>

  <div id="sheet-container"></div>
</div>

<script type="module">
import { OpenSheetMusicDisplay } from 'opensheetmusiclibrary.min.js';
import Soundfont from 'https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.js';

let osmd;
let audioContext = new (window.AudioContext || window.webkitAudioContext)();
let currentInstrument;
let bpm = 120;
let listeningMode = true;
let midiAccess = null;
let activeNotes = new Set();

const container = document.getElementById('sheet-container');
const speedRange = document.getElementById('speed-range');
const speedDisplay = document.getElementById('speed-display');
const modeToggle = document.getElementById('mode-toggle');

speedRange.addEventListener('input', () => {
  bpm = parseInt(speedRange.value);
  speedDisplay.textContent = bpm + ' BPM';
});

modeToggle.addEventListener('change', () => listeningMode = modeToggle.checked);

document.getElementById('instrument-select').addEventListener('change', async (e) => {
  const instrumentName = e.target.value;
  currentInstrument = await Soundfont.instrument(audioContext, instrumentName);
});

document.getElementById('file-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (event) => {
    osmd = new OpenSheetMusicDisplay(container, { autoResize:true });
    await osmd.load(event.target.result);
    await osmd.render();
    highlightMeasures();
  };
  reader.readAsText(file);
});

document.getElementById('play-btn').addEventListener('click', async () => {
  if (!osmd || !currentInstrument) return alert('Load a file and select an instrument.');
  playSequence();
});

document.getElementById('stop-btn').addEventListener('click', () => {
  audioContext.close();
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
});

function highlightMeasures() {
  const measures = osmd.GraphicSheet.MeasureElements;
  measures.forEach(measure => {
    measure.notes.forEach(note => {
      note.cursorHighlight = false;
    });
  });
}

async function playSequence() {
  const measures = osmd.GraphicSheet.MeasureElements;
  let timeOffset = audioContext.currentTime;

  for (let measure of measures) {
    for (let note of measure.Notes) {
      if (note.MidiPitch) {
        if (listeningMode) {
          currentInstrument.play(note.MidiPitch, timeOffset, { duration: 0.5*(120/bpm) });
        } else {
          // Training mode: play only when correct MIDI key is pressed
          await waitForMidiNote(note.MidiPitch);
          currentInstrument.play(note.MidiPitch, audioContext.currentTime, { duration: 0.5*(120/bpm) });
        }
        note.cursorHighlight = true;
        osmd.render();
        await new Promise(r => setTimeout(r, 500*(120/bpm)));
        note.cursorHighlight = false;
        osmd.render();
      }
    }
  }
}

async function waitForMidiNote(targetPitch) {
  return new Promise(resolve => {
    const handler = (event) => {
      const note = event.data[1];
      if (note === targetPitch) {
        resolve();
        if (midiAccess) midiAccess.inputs.forEach(input => input.onmidimessage = null);
      }
    };
    if (midiAccess) midiAccess.inputs.forEach(input => input.onmidimessage = handler);
  });
}

navigator.requestMIDIAccess().then((access) => {
  midiAccess = access;
});
</script>
</body>
</html>
