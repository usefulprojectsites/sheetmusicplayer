<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Sheet Music Trainer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://unpkg.com/opensheetmusicdisplay@1.8.7/build/opensheetmusicdisplay.min.js"></script>
<style>
body { background:#f9fafb; font-family: 'Segoe UI', sans-serif; }
.container { max-width: 1200px; margin:40px auto; }
#sheet { border:1px solid #ddd; border-radius:10px; padding:20px; background:#fff; min-height:250px; margin-bottom:25px; }
#piano { display:flex; overflow-x:auto; margin-top:20px; height:160px; }
.white { width:40px; height:160px; background:#fff; border:1px solid #444; position:relative; }
.black { width:26px; height:100px; background:#000; position:absolute; top:0; left:28px; z-index:2; }
.key.mark { box-shadow: inset 0 0 10px #22c55e; }
.key.correct { background: #22c55e !important; }
.key.wrong { background: #ef4444 !important; }
#instrumentPanel { border:1px solid #ddd; border-radius:10px; padding:20px; background:#fff; margin-top:20px; }
.fingerboard, .windchart { width:100%; height:200px; background:#f0f0f0; border-radius:10px; position:relative; }
.position { width:20px; height:20px; border-radius:50%; background:#22c55e; position:absolute; }
.toggle { display:flex; align-items:center; gap:10px; }
</style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">ðŸŽ¼ AI Sheet Music Trainer</h1>
  <div class="mb-3">
    <label class="form-label">Upload MusicXML</label>
    <input type="file" id="file" accept=".musicxml,.xml,.mxl" class="form-control"/>
  </div>
  <div class="mb-3 d-flex flex-wrap gap-3">
    <select id="instrument" class="form-select" style="min-width:200px">
      <option value="piano">ðŸŽ¹ Piano</option>
      <option value="violin">ðŸŽ» Violin</option>
      <option value="guitar">ðŸŽ¸ Guitar</option>
      <option value="flute">ðŸŽ¶ Flute</option>
      <option value="clarinet">ðŸŽ¼ Clarinet</option>
      <option value="trombone">ðŸŽº Trombone</option>
      <option value="cello">ðŸŽ» Cello</option>
    </select>
    <div class="toggle">
      <label>Mode:</label>
      <button class="btn btn-outline-primary" id="listenBtn">Listen</button>
      <button class="btn btn-outline-success" id="trainBtn">Train</button>
    </div>
    <div><label>BPM:</label> <input type="range" min="40" max="200" value="120" id="bpmRange"/></div>
    <span id="bpmValue">120</span>
  </div>
  <div id="sheet"></div>
  <div id="piano"></div>
  <div id="instrumentPanel" class="collapse show">
    <h4>Instrument Guide</h4>
    <div id="guideArea"></div>
  </div>
</div>

<script>
let osmd, mode="listen", bpm=120, steps=[], stepIndex=0, expected=new Set();

function renderPiano(){
  const p=document.getElementById("piano"); p.innerHTML="";
  for(let midi=21;midi<=108;midi++){
    const note=midi%12;
    const isWhite=[0,2,4,5,7,9,11].includes(note);
    if(isWhite){
      const w=document.createElement("div"); w.className="key white"; w.dataset.midi=midi;
      if(![4,11].includes(note)){
        const b=document.createElement("div"); b.className="key black"; b.dataset.midi=midi+1;
        w.appendChild(b);
      }
      p.appendChild(w);
    }
  }
}

function markKeys(set){document.querySelectorAll(".key").forEach(k=>k.classList.remove("mark")); set.forEach(m=>{const el=document.querySelector(`.key[data-midi="${m}"]`); if(el) el.classList.add("mark");});}
function flashKey(midi,ok){const el=document.querySelector(`.key[data-midi="${midi}"]`); if(!el)return; el.classList.add(ok?"correct":"wrong"); setTimeout(()=>el.classList.remove("correct","wrong"),300);}

function buildSteps(){steps=[]; const c=osmd.cursor; c.show(); c.reset(); while(!c.iterator.endReached){const s=new Set(); c.iterator.CurrentVoiceEntries?.forEach(ve=>ve.Notes.forEach(n=>{if(n.Pitch?.Midi) s.add(n.Pitch.Midi);})); steps.push(s); c.next();} c.reset(); c.hide(); stepIndex=0; expected=steps[0]||new Set(); markKeys(expected);}
function nextStep(){if(stepIndex+1<steps.length){stepIndex++; expected=steps[stepIndex]; markKeys(expected); updateGuide();}}

function updateGuide(){
  const area=document.getElementById("guideArea"); area.innerHTML="";
  const inst=document.getElementById("instrument").value;
  if(inst==="piano") return;
  const div=document.createElement("div");
  if(inst==="violin"||inst==="cello"){div.className="fingerboard"; const pos=document.createElement("div"); pos.className="position"; pos.style.left="40%"; pos.style.top="30%"; div.appendChild(pos);}
  if(inst==="guitar"){div.className="fingerboard"; const pos=document.createElement("div"); pos.className="position"; pos.style.left="60%"; pos.style.top="50%"; div.appendChild(pos);}
  if(inst==="flute"||inst==="clarinet"||inst==="trombone"){div.className="windchart"; const pos=document.createElement("div"); pos.className="position"; pos.style.left="50%"; pos.style.top="40%"; div.appendChild(pos);}
  area.appendChild(div);
}

document.getElementById("file").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ev=>{
    osmd=new opensheetmusicdisplay.OpenSheetMusicDisplay("sheet",{autoResize:true});
    await osmd.load(ev.target.result); await osmd.render();
    buildSteps(); updateGuide();
  };
  r.readAsText(f);
});
document.getElementById("listenBtn").onclick=()=>{mode="listen";};
document.getElementById("trainBtn").onclick=()=>{mode="train";};
document.getElementById("bpmRange").oninput=e=>{bpm=e.target.value; document.getElementById("bpmValue").innerText=bpm;};

renderPiano();
</script>
</body>
</html>
